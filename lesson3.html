<html>
    <head>
        <title>Messages, Models &amp; Routes</title>
        <link href="lib/bootstrap.css" rel="stylesheet" />
        <link href="lib/prism.css" rel="stylesheet" />
        <link href="lib/style.css" rel="stylesheet" type="text/css" media="all" />
        <script src="lib/lodash.min.js"></script>
        <script src="lib/radio.min.js"></script>
        <script src="lib/react.js"></script>
        <script src="lib/prism.js"></script>
        <script src="lib/JSXTransformer.js"></script>
        <script src="lib/sourceview.js"></script>
        <script type="text/jsx" id="useMessageSource">
          /** @jsx React.DOM */
          var ChatSession = React.createClass({
              getInitialState: function() {
                  return {
                      messages: this.props.messages || []
                  }
              },
              componentWillMount: function() {
                  radio(this.props.channel + ".message.received").subscribe(this.receiveMessage);
              },
              componentWillUnmount: function() {
                  radio(this.props.channel + ".message.received").unsubscribe(this.receiveMessage);
              },
              receiveMessage: function(message) {
                  var messages = this.state.messages;
                  messages.push(message);
                  this.setState({messages: messages})
              },
              renderMessage: function(message) {
                  return <li key={message.id}>{message.message}</li>
              },
              sendMessage: function(event) {
                  var input = this.refs.input;
                  radio(this.props.channel + ".message.send").broadcast({message: input.state.value});
                  input.setState({value: ""});
              },
              render: function() {
                  return <div>
                      <h3>Chat Connection ({this.props.channel})</h3>
                      <ol>
                        {_.map(this.state.messages, this.renderMessage)}
                      </ol>
                      <fieldset>
                          <input ref="input" type="text"/>
                          <button onClick={this.sendMessage}>Send</button>
                      </fieldset>
                    </div>;
              }
          });

          var FuseSessionChats = function(channel1, channel2) {
              function send(channel, msg) {
                radio(channel + ".message.received").broadcast({
                    message: msg,
                    id: _.uniqueId()
                });
              }

              radio(channel1 + ".message.send").subscribe(function(data) {
                  send(channel2, "["+channel1+"]:"+data.message);
              });
              radio(channel2 + ".message.send").subscribe(function(data) {
                  send(channel1, "["+channel2+"]:"+data.message);
              });

              send(channel1, "[Client] Connection established");
              send(channel2, "[Client] Connection established");
          };


          React.renderComponent(
            <div>
                <ChatSession channel="chat1"/>
                <ChatSession channel="chat2"/>
            </div>,
            document.getElementById('useMessage')
          );
          FuseSessionChats("chat1", "chat2")
        </script>
        <script type="text/jsx" id="routesSource">
          /** @jsx React.DOM */
          var UberTag = React.createClass({
              getInitialState: function() {
                  return {
                      clicks: this.props.clicks || 0
                  };
              },
              increment: function() {
                  this.setState({clicks: this.state.clicks + 1});
              },
              render: function() {
                  return <div>
                          <button onClick={this.increment}>{this.props.children}</button>
                          {this.state.clicks ? <span>Number of clicks: {this.state.clicks} </span> : null}
                         </div>;
              }
          });

          React.renderComponent(
            <UberTag clicks={-1}>Hello World</UberTag>,
            document.getElementById('routes')
          );
        </script>
    </head>
    <body>
        <section class="container">
            <h1>Messages</h1>
            <div class="row">
                <div class="col-sm-4">
                    <p>
                        Channels allow for asynchronous message passing between code routines.
                        In this example we are using Radio which is a minimalist pub/sub library.
                        Other libraries like Postal.js offer more features like topics, promise integration, and responses.
                        Messages can even be sent to web workers or to an iframe.
                    </p>
                    <ul>
                        <li>Use channels (aka pub/sub) to send messages to other components and systems</li>
                        <li>Subscribe to a topic on a channel to be notified of events</li>
                        <li>Your component is an Actor</li>
                        <li>Subscribe to topics in "componentWillMount"</li>
                        <li>Unsubscribe from topics in "componentWillUnmount"</li>
                    </ul>
                    <div class="result" id="useMessage"></div>
                </div>
                <div class="col-sm-8">
                    <div class="sourceCode" data-source="useMessageSource" data-edit="true"></div>
                </div>
            </div>
        </section>
        <section class="container">
            <h1>Ajax &amp; Model Layer</h1>
            <div class="row">
                <div class="col-sm-12">
                    <p> Due to time constraints and lack of good public cross origin APIs the example for this has been skipped </p>
                    <p>
                        If components are editing data on a server then it is recommended that you use a model layer.
                        It is recommended that you use messages to integrate React.js with the model layer.
                        React.js doesn't care what is being used for the model layer or if AJAX is directly called as long as updates are pushed through "setState".
                    </p>
                    <ul>
                        <li>Choose your data backend</li>
                        <li>Bind to your model layer using messages</li>
                        <li>Ajax requests are messages made to the internet</li>
                    </ul>
                </div>
            </div>
        </section>
        <section class="container">
            <h1>Routes</h1>
            <div class="row">
                <div class="col-sm-4">
                    <ul>
                        <li>A component can act as a view controller</li>
                        <li>Tree structure allows the current state to be presented as a url</li>
                    </ul>
                    <div class="result" id="routes"></div>
                </div>
                <div class="col-sm-8">
                    <div class="sourceCode" data-source="routesSource" data-edit="true"></div>
                </div>
            </div>
        </section>
    </body>
</html>
